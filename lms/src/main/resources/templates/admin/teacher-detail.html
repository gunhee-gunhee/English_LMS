<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>講師詳細・修正</title>

    <!-- テンプレート用のカスタムフォント -->
    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet">
    <link th:href="@{/vendor/datatables/dataTables.bootstrap4.min.css}" rel="stylesheet">

    <style>
        .radio-group label { display: block; margin-bottom: 6px; }
        button[aria-expanded="true"] {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body id="page-top">

<div id="wrapper">
    <!-- サイドバー -->
    <div th:replace="~{fragments/sidebar-admin :: sidebar-admin}"></div>

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <!-- トップバー -->
            <div th:replace="~{fragments/topbar :: topbar('講師詳細')}"></div>

            <div class="container-fluid">
                <div class="card shadow mb-4">
                    <div class="card-body">

                        <!-- 成功/エラーメッセージ -->
                        <div th:if="${teacherSuccess != null}" class="alert alert-success" th:text="${teacherSuccess}"></div>
                        <div th:if="${teacherError != null}" class="alert alert-danger" th:text="${teacherError}"></div>

                        <form th:action="@{|/admin/teacher/detail/${teacherNum}|}" th:object="${teacherDTO}" method="post" autocomplete="off">
                            <!-- ユーザーID（編集不可） -->
                            <div class="form-group">
                                <label>ユーザーID</label>
                                <input type="text" id="teacherId" th:field="*{id}" class="form-control" readonly>
                            </div>
                            <!-- パスワード（空欄の場合は変更なし） -->
                            <div class="form-group">
                                <label>パスワード (変更時のみ入力)</label>
                                <input type="password" id="teacherPassword" th:field="*{password}" class="form-control" placeholder="新しいパスワード">
                            </div>
							<div class="form-group">
							    <label>パスワード確認</label>
							    <input type="password" id="teacherPasswordCheck" th:field="*{passwordCheck}" class="form-control" placeholder="パスワードをもう一度入力してください">
							</div>
							<div th:if="${studentError != null}" class="alert alert-danger" th:text="${studentError}"></div>
                            <!-- ニックネーム -->
                            <div class="form-group">
                                <label>ニックネーム</label>
                                <input type="text" id="teacherNickname" th:field="*{nickname}" class="form-control">
                            </div>
                            <!-- Zoom ID -->
                            <div class="form-group">
                                <label for="inputZoomId">Zoom ID</label>
								<select class="form-control" id="inputZoomId" th:field="*{zoomId}">
								    <option th:each="id : ${zoomIdList}" th:value="${id}" th:text="${id}"></option>
								</select>
                            </div>
                            <!-- 無効化 -->
							<div class="form-group form-check">
							    <input type="checkbox" th:field="*{nullity}" class="form-check-input" id="nullityCheckbox">
							    <label class="form-check-label" for="nullityCheckbox">無効化（チェック時は停止）</label>
							</div>
                            <!-- 登録日（編集不可） -->
                            <div class="form-group">
                                <label>登録日</label>
                                <input type="text" th:value="*{join_date}" class="form-control" readonly>
                            </div>

                            <!-- 授業スケジュールリスト -->
                            <div>
                                <label>授業スケジュール</label>
                                <div id="scheduleBoxList">
                                    <!-- 既存スケジュール表示（削除ボタン付き） -->
                                    <div th:each="schedule, idx : *{schedules}" class="card mb-3 schedule-item">
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label>授業曜日</label>
                                                <div class="btn-group btn-group-toggle d-flex flex-wrap" data-toggle="buttons">
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '日')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="日" autocomplete="off">日
                                                    </label>
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '月')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="月" autocomplete="off">月
                                                    </label>
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '火')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="火" autocomplete="off">火
                                                    </label>
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '水')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="水" autocomplete="off">水
                                                    </label>
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '木')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="木" autocomplete="off">木
                                                    </label>
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '金')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="金" autocomplete="off">金
                                                    </label>
                                                    <label class="btn btn-outline-primary m-1" th:classappend="${#lists.contains(schedule.weekdays, '土')} ? 'active'">
                                                        <input type="checkbox" th:field="*{schedules[__${idx.index}__].weekdays}" value="土" autocomplete="off">土
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="form-group d-flex flex-wrap align-items-center">
                                                <label class="mr-2">開始</label>
                                                <select th:field="*{schedules[__${idx.index}__].startHour}" class="form-control mx-1" style="width:80px;">
                                                    <option value="">--</option>
                                                    <option th:each="h : ${#numbers.sequence(0,23)}" th:value="${h}" th:text="${h == 0 ? '00' : h}"></option>
                                                </select>時
                                                <select th:field="*{schedules[__${idx.index}__].startMinute}" class="form-control mx-1" style="width:80px;">
                                                    <option value="">--</option>
                                                    <option th:each="m : ${#numbers.sequence(0,50,10)}" th:value="${m}" th:text="${m == 0 ? '00' : m}"></option>
                                                </select>分
                                                <span class="mx-2">〜</span>
                                                <label class="mr-2">終了</label>
                                                <select th:field="*{schedules[__${idx.index}__].endHour}" class="form-control mx-1" style="width:80px;">
                                                    <option value="">--</option>
                                                    <option th:each="h : ${#numbers.sequence(0,23)}" th:value="${h}" th:text="${h == 0 ? '00' : h}"></option>
                                                </select>時
                                                <select th:field="*{schedules[__${idx.index}__].endMinute}" class="form-control mx-1" style="width:80px;">
                                                    <option value="">--</option>
                                                    <option th:each="m : ${#numbers.sequence(0,50,10)}" th:value="${m}" th:text="${m == 0 ? '00' : m}"></option>
                                                </select>分
												<button type="button" class="btn btn-sm btn-danger removeScheduleBtn d-block w-100 mt-2">スケジュール削除</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- スケジュール追加ボタン -->
                            <button type="button" id="addScheduleBtn" class="btn btn-primary btn-user mb-3">
                                スケジュール追加
                            </button>
                            <button type="submit" class="btn btn-primary btn-block">修正を保存</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- フッター -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Your Website 2020</span>
                </div>
            </div>
        </footer>
    </div>
</div>
<!-- ページトップボタン -->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- ログアウトモーダル -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">ログアウトしますか？</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">「Logout」を選択すると現在のセッションが終了します。</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">キャンセル</button>
                <a class="btn btn-primary" href="login.html">Logout</a>
            </div>
        </div>
    </div>
</div>

<!-- jQuery & スケジュール追加/削除用スクリプト -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Custom scripts for all pages-->
  <script th:src="@{/js/sb-admin-2.min.js}"></script>

 <!--授業年月日JS-->
<script th:src="@{/js/class-period.js}"></script>

 <!--講師スケジュールの追加-->
<script th:src="@{/js/add-schedule.js}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const pw = document.getElementById('teacherPassword').value;
        const pwCheck = document.getElementById('teacherPasswordCheck').value;
		if (teacherDTO.getPassword() != null && !teacherDTO.getPassword().isEmpty()) {
		    if (!teacherDTO.getPassword().equals(teacherDTO.getPasswordCheck())) {
		        log.warn("[講師更新] パスワードが一致しません (ID: {})", teacher.getTeacherId());
		        throw new IllegalArgumentException("パスワードが一致しません。");
		    }
		    log.info("[講師更新] パスワードを更新します (ID: {})", teacher.getTeacherId());
		    teacher.setPassword(passwordEncoder.encode(teacherDTO.getPassword()));
		}
    });
});
</script>

</script>
</body>
</html>
